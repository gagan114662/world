<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Channel 1 - Live Feed Observer</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Monaco', 'Menlo', monospace;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            min-height: 100vh;
        }
        h1 {
            color: #FFD93D;
            margin-bottom: 10px;
            border-bottom: 3px solid #FFD93D;
            padding-bottom: 10px;
        }
        .subtitle {
            color: #888;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .status {
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
            display: inline-block;
        }
        .status.connected { background: #4ADE80; color: #000; }
        .status.disconnected { background: #FF6B6B; color: #fff; }
        .status.connecting { background: #FFD93D; color: #000; }

        .config {
            background: #16213e;
            border: 2px solid #0f3460;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .config label {
            display: block;
            margin-bottom: 5px;
            color: #888;
            font-size: 12px;
        }
        .config-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .config-row > div { flex: 1; min-width: 200px; }
        input, select {
            background: #0f0f23;
            border: 2px solid #333;
            color: #fff;
            padding: 8px 12px;
            font-family: inherit;
            width: 100%;
            border-radius: 4px;
        }
        button {
            background: #C4B5FD;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-weight: bold;
            cursor: pointer;
            margin-right: 10px;
            font-family: inherit;
            border-radius: 4px;
        }
        button:hover { background: #FFD93D; }
        button:disabled { background: #444; color: #888; cursor: not-allowed; }
        button.danger { background: #FF6B6B; }
        button.danger:hover { background: #ff4444; }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .video-panel {
            background: #16213e;
            border: 2px solid #0f3460;
            border-radius: 8px;
            padding: 15px;
        }
        .video-panel h2 {
            color: #4ADE80;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        .video-container {
            background: #000;
            border-radius: 4px;
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .video-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .video-placeholder {
            color: #444;
            font-size: 14px;
        }

        .transcript-panel {
            background: #16213e;
            border: 2px solid #0f3460;
            border-radius: 8px;
            padding: 15px;
        }
        .transcript-panel h2 {
            color: #C4B5FD;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        .transcript-log {
            background: #0f0f23;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.8;
        }
        .transcript-entry {
            padding: 8px 0;
            border-bottom: 1px solid #222;
        }
        .transcript-entry .timestamp {
            color: #666;
            font-size: 11px;
            margin-bottom: 4px;
        }
        .transcript-entry .speaker {
            font-weight: bold;
            font-size: 10px;
            text-transform: uppercase;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 8px;
        }
        .transcript-entry .speaker.user {
            background: #4ADE80;
            color: #000;
        }
        .transcript-entry .speaker.tutor {
            background: #C4B5FD;
            color: #000;
        }
        .transcript-entry.user .text {
            color: #4ADE80;
        }
        .transcript-entry.tutor .text {
            color: #C4B5FD;
        }
        .transcript-entry.system {
            background: rgba(255, 217, 61, 0.1);
            border-left: 3px solid #FFD93D;
        }
        .transcript-entry .speaker.system {
            background: #FFD93D;
            color: #000;
        }
        .transcript-entry.system .text {
            color: #FFD93D;
        }

        .instruction-panel {
            background: #16213e;
            border: 2px solid #FFD93D;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            margin-bottom: 20px;
        }
        .instruction-panel textarea {
            background: #0f0f23;
            border: 2px solid #333;
            color: #fff;
            padding: 12px;
            font-family: inherit;
            width: 100%;
            border-radius: 4px;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 10px;
        }
        .instruction-panel textarea:focus {
            border-color: #FFD93D;
            outline: none;
        }
        .instruction-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .instruction-controls button {
            background: #FFD93D;
            color: #000;
        }
        .instruction-controls button:hover {
            background: #ffed4a;
        }
        .instruction-status {
            font-size: 12px;
            color: #888;
        }
        .instruction-status.success { color: #4ADE80; }
        .instruction-status.error { color: #FF6B6B; }

        .audio-panel {
            background: #16213e;
            border: 2px solid #0f3460;
            border-radius: 8px;
            padding: 15px;
            grid-column: 1 / -1;
        }
        .audio-panel h2 {
            color: #FFD93D;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
        }
        .audio-controls button {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .volume-slider {
            width: 150px;
        }
        .audio-visualizer {
            background: #0f0f23;
            border: 1px solid #333;
            border-radius: 4px;
            height: 60px;
        }

        .stats {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat {
            background: #16213e;
            border: 2px solid #0f3460;
            padding: 12px 20px;
            border-radius: 8px;
            text-align: center;
            min-width: 120px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #FFD93D;
        }
        .stat-label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            margin-top: 4px;
        }

        .debug-panel {
            background: #0f0f23;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 15px;
        }
        .debug-panel h3 {
            color: #888;
            margin-bottom: 10px;
            font-size: 12px;
        }
        .debug-log {
            height: 100px;
            overflow-y: auto;
            font-size: 11px;
            line-height: 1.4;
        }
        .debug-log .info { color: #888; }
        .debug-log .success { color: #4ADE80; }
        .debug-log .error { color: #FF6B6B; }
        .debug-log .warn { color: #FFD93D; }

        .session-selector {
            background: #0f0f23;
            border: 2px solid #C4B5FD;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .session-selector h3 {
            color: #C4B5FD;
            margin-bottom: 10px;
        }
        .session-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .session-item {
            background: #16213e;
            border: 2px solid #0f3460;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        .session-item:hover { border-color: #C4B5FD; }
        .session-item.selected { border-color: #4ADE80; background: #1a3a2e; }
        .session-item .session-id { font-weight: bold; color: #fff; }
        .session-item .session-user { color: #888; font-size: 12px; }
        .session-item .session-status { font-size: 11px; margin-top: 4px; }
        .session-item .session-status.active { color: #4ADE80; }
    </style>
</head>
<body>
    <p class="subtitle">Backend dev tool to monitor live tutoring sessions in real-time</p>

    <div class="config">
        <div class="config-row">
            <div>
                <label>API URL:</label>
                <input type="text" id="apiUrl" value="http://localhost:8002">
            </div>
            <div>
                <label>Observer API Key:</label>
                <input type="text" id="apiKey" value="dev-observer-key-12345">
            </div>
        </div>
        <div style="margin-top: 10px;">
            <button onclick="fetchActiveSessions()">Refresh Sessions</button>
            <button onclick="disconnect()" class="danger" id="disconnectBtn" disabled>Disconnect</button>
            <span id="status" class="status disconnected" style="margin-left: 15px;">DISCONNECTED</span>
        </div>
    </div>

    <div class="session-selector" id="sessionSelector">
        <h3>Active Sessions</h3>
        <div class="session-list" id="sessionList">
            <span style="color: #666;">Click "Refresh Sessions" to load active sessions</span>
        </div>
    </div>

    <h1>Channel 1 - Live Feed Observer</h1>

    <div class="stats">
        <div class="stat">
            <div class="stat-value" id="videoFrames">0</div>
            <div class="stat-label">Video Frames</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="audioChunks">0</div>
            <div class="stat-label">Audio Chunks</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="transcripts">0</div>
            <div class="stat-label">Transcripts</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="dataReceived">0</div>
            <div class="stat-label">KB Received</div>
        </div>
    </div>

    <div class="main-grid">
        <div class="video-panel">
            <h2>Video Feed</h2>
            <div class="video-container">
                <img id="videoFrame" style="display: none;">
                <span class="video-placeholder" id="videoPlaceholder">Waiting for video frames...</span>
            </div>
        </div>

        <div class="transcript-panel">
            <h2>Conversation Transcript</h2>
            <div class="transcript-log" id="transcriptLog">
                <div style="color: #666;">Waiting for transcript data...</div>
            </div>
        </div>

        <div class="audio-panel">
            <h2>Audio Stream</h2>
            <div class="audio-controls">
                <button onclick="toggleAudio()" id="audioToggleBtn">
                    <span id="audioIcon">üîá</span>
                    <span id="audioLabel">Unmute</span>
                </button>
                <label style="color: #888; font-size: 12px;">Volume:</label>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50" onchange="setVolume(this.value)">
                <span id="volumeValue" style="color: #888; font-size: 12px;">50%</span>
            </div>
            <canvas class="audio-visualizer" id="audioVisualizer"></canvas>
        </div>
    </div>

    <h1 style="margin-top: 30px;">Channel 2 - Send Instruction to Tutor</h1>

    <div class="instruction-panel">
        <textarea id="instructionText" placeholder="Enter an instruction for the AI tutor (e.g., 'Ask the student about quadratic equations' or 'Switch to a more encouraging tone')..."></textarea>
        <div class="instruction-controls">
            <button onclick="sendInstruction()" id="sendInstructionBtn">Send Instruction</button>
            <span class="instruction-status" id="instructionStatus"></span>
        </div>
    </div>

    <div class="debug-panel">
        <h3>Debug Log</h3>
        <div class="debug-log" id="debugLog"></div>
    </div>

    <script>
        let ws = null;
        let selectedSessionId = null;
        let stats = { video: 0, audio: 0, transcript: 0, bytes: 0 };

        // Audio playback
        let audioContext = null;
        let audioGainNode = null;
        let audioMuted = true;
        let audioQueue = [];
        let isPlayingAudio = false;

        function getTimestamp() {
            return new Date().toLocaleTimeString('en-US', { hour12: false, fractionalSecondDigits: 3 });
        }

        function debugLog(message, type = 'info') {
            const log = document.getElementById('debugLog');
            const entry = document.createElement('div');
            entry.className = type;
            entry.innerHTML = `[${getTimestamp()}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;

            // Keep log size manageable
            while (log.children.length > 100) {
                log.removeChild(log.firstChild);
            }
        }

        function setStatus(status, text) {
            const el = document.getElementById('status');
            el.className = `status ${status.toLowerCase()}`;
            el.textContent = text || status.toUpperCase();
        }

        function updateStats() {
            document.getElementById('videoFrames').textContent = stats.video;
            document.getElementById('audioChunks').textContent = stats.audio;
            document.getElementById('transcripts').textContent = stats.transcript;
            document.getElementById('dataReceived').textContent = (stats.bytes / 1024).toFixed(1);
        }

        async function fetchActiveSessions() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();

            debugLog('Fetching active sessions...', 'info');

            try {
                const response = await fetch(`${apiUrl}/sessions/active?api_key=${encodeURIComponent(apiKey)}`);

                if (!response.ok) {
                    const error = await response.text();
                    debugLog(`Failed to fetch sessions: ${response.status} ${error}`, 'error');
                    return;
                }

                const data = await response.json();
                const sessions = data.sessions || [];

                const listEl = document.getElementById('sessionList');

                if (sessions.length === 0) {
                    listEl.innerHTML = '<span style="color: #666;">No active sessions found. Start a tutoring session from the frontend.</span>';
                    debugLog('No active sessions found', 'warn');
                    return;
                }

                listEl.innerHTML = sessions.map(s => `
                    <div class="session-item ${s.session_id === selectedSessionId ? 'selected' : ''}"
                         onclick="selectSession('${s.session_id}')">
                        <div class="session-id">${s.session_id}</div>
                        <div class="session-user">User: ${s.user_id}</div>
                        <div class="session-status active">
                            WS: ${s.websocket_connected ? '‚úÖ' : '‚ùå'} |
                            SSE: ${s.sse_connected ? '‚úÖ' : '‚ùå'} |
                            Q: ${s.questions_answered}
                        </div>
                    </div>
                `).join('');

                debugLog(`Found ${sessions.length} active session(s)`, 'success');

            } catch (e) {
                debugLog(`Error fetching sessions: ${e.message}`, 'error');
            }
        }

        function selectSession(sessionId) {
            selectedSessionId = sessionId;

            // Update UI
            document.querySelectorAll('.session-item').forEach(el => {
                el.classList.remove('selected');
                if (el.querySelector('.session-id').textContent === sessionId) {
                    el.classList.add('selected');
                }
            });

            debugLog(`Selected session: ${sessionId}`, 'info');

            // Auto-connect
            connect();
        }

        function connect() {
            if (!selectedSessionId) {
                debugLog('No session selected', 'error');
                return;
            }

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }

            const apiUrl = document.getElementById('apiUrl').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const wsUrl = apiUrl.replace('http', 'ws');

            setStatus('connecting');
            debugLog(`Connecting to observe session ${selectedSessionId}...`, 'info');

            const url = `${wsUrl}/ws/feed/observe?api_key=${encodeURIComponent(apiKey)}&session_id=${encodeURIComponent(selectedSessionId)}`;

            try {
                ws = new WebSocket(url);
            } catch (e) {
                debugLog(`Failed to create WebSocket: ${e.message}`, 'error');
                setStatus('disconnected');
                return;
            }

            ws.onopen = () => {
                debugLog('Observer WebSocket connected', 'success');
                setStatus('connected', 'OBSERVING');
                document.getElementById('disconnectBtn').disabled = false;

                // Initialize audio context on user interaction (needed for browsers)
                initAudioContext();
            };

            ws.onclose = (event) => {
                debugLog(`WebSocket closed: ${event.code} ${event.reason}`, event.code === 1000 ? 'info' : 'warn');
                setStatus('disconnected');
                document.getElementById('disconnectBtn').disabled = true;
            };

            ws.onerror = (error) => {
                debugLog('WebSocket error', 'error');
                setStatus('disconnected');
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    stats.bytes += event.data.length;
                    handleMessage(data);
                    updateStats();
                } catch (e) {
                    debugLog(`Failed to parse message: ${e.message}`, 'error');
                }
            };
        }

        function disconnect() {
            if (ws) {
                ws.close(1000, 'User disconnect');
                ws = null;
            }
            debugLog('Disconnected', 'info');
        }

        function handleMessage(data) {
            const type = data.type;
            const payload = data.data || {};
            const timestamp = data.timestamp;

            switch (type) {
                case 'session_info':
                    debugLog(`Session info: ${payload.message}`, 'success');
                    break;

                case 'video':
                case 'media':
                    stats.video++;
                    handleVideoFrame(payload.media);
                    break;

                case 'audio':
                    stats.audio++;
                    handleAudioChunk(payload.audio);
                    break;

                case 'transcript':
                    stats.transcript++;
                    handleTranscript(payload.transcript, timestamp, payload.speaker);
                    break;

                case 'keepalive':
                case 'pong':
                    // Silent keepalive
                    break;

                default:
                    debugLog(`Unknown message type: ${type}`, 'warn');
            }
        }

        function handleVideoFrame(base64) {
            if (!base64) return;

            const img = document.getElementById('videoFrame');
            const placeholder = document.getElementById('videoPlaceholder');

            img.src = `data:image/jpeg;base64,${base64}`;
            img.style.display = 'block';
            placeholder.style.display = 'none';
        }

        // Track current speaker for appending to same line
        let currentSpeaker = null;
        let currentEntry = null;

        function handleTranscript(text, timestamp, speaker = 'tutor') {
            if (!text) return;

            const log = document.getElementById('transcriptLog');

            // Remove placeholder on first transcript
            if (log.querySelector('.placeholder') || log.innerHTML.includes('Waiting for')) {
                log.innerHTML = '';
            }

            // If same speaker, append to current line
            if (speaker === currentSpeaker && currentEntry) {
                const textEl = currentEntry.querySelector('.text');
                if (textEl) {
                    textEl.textContent += ' ' + text;
                    log.scrollTop = log.scrollHeight;
                    return;
                }
            }

            // New speaker - create new entry
            currentSpeaker = speaker;
            const entry = document.createElement('div');
            entry.className = `transcript-entry ${speaker}`;

            const speakerLabel = speaker === 'user' ? 'USER' : 'TUTOR';
            entry.innerHTML = `
                <div class="timestamp">
                    <span class="speaker ${speaker}">${speakerLabel}</span>
                    ${timestamp || getTimestamp()}
                </div>
                <div class="text">${text}</div>
            `;
            log.appendChild(entry);
            currentEntry = entry;
            log.scrollTop = log.scrollHeight;

            // Keep log size manageable
            while (log.children.length > 50) {
                log.removeChild(log.firstChild);
                // Reset current entry if it was removed
                if (!log.contains(currentEntry)) {
                    currentEntry = null;
                    currentSpeaker = null;
                }
            }
        }

        // Audio handling
        function initAudioContext() {
            if (audioContext) return;

            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 16000
                });
                audioGainNode = audioContext.createGain();
                audioGainNode.connect(audioContext.destination);
                audioGainNode.gain.value = audioMuted ? 0 : 0.5;
                debugLog('Audio context initialized (16kHz PCM)', 'success');
            } catch (e) {
                debugLog(`Failed to init audio: ${e.message}`, 'error');
            }
        }

        function handleAudioChunk(base64) {
            if (!base64 || !audioContext || audioMuted) return;

            try {
                // Decode base64 to binary
                const binaryString = atob(base64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }

                // Convert 16-bit PCM to Float32 for Web Audio
                const pcm16 = new Int16Array(bytes.buffer);
                const float32 = new Float32Array(pcm16.length);
                for (let i = 0; i < pcm16.length; i++) {
                    float32[i] = pcm16[i] / 32768.0;
                }

                // Queue for playback
                audioQueue.push(float32);

                if (!isPlayingAudio) {
                    playNextAudioChunk();
                }

                // Update visualizer
                updateAudioVisualizer(float32);

            } catch (e) {
                // Silent fail for audio - don't spam logs
            }
        }

        function playNextAudioChunk() {
            if (audioQueue.length === 0 || audioMuted) {
                isPlayingAudio = false;
                return;
            }

            isPlayingAudio = true;
            const float32 = audioQueue.shift();

            const buffer = audioContext.createBuffer(1, float32.length, 16000);
            buffer.getChannelData(0).set(float32);

            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioGainNode);
            source.onended = playNextAudioChunk;
            source.start();
        }

        function toggleAudio() {
            audioMuted = !audioMuted;

            const icon = document.getElementById('audioIcon');
            const label = document.getElementById('audioLabel');

            if (audioMuted) {
                icon.textContent = 'üîá';
                label.textContent = 'Unmute';
                if (audioGainNode) audioGainNode.gain.value = 0;
                audioQueue = []; // Clear queue when muting
            } else {
                icon.textContent = 'üîä';
                label.textContent = 'Mute';
                initAudioContext();
                if (audioGainNode) {
                    const volume = document.getElementById('volumeSlider').value / 100;
                    audioGainNode.gain.value = volume;
                }
            }

            debugLog(`Audio ${audioMuted ? 'muted' : 'unmuted'}`, 'info');
        }

        function setVolume(value) {
            document.getElementById('volumeValue').textContent = `${value}%`;
            if (audioGainNode && !audioMuted) {
                audioGainNode.gain.value = value / 100;
            }
        }

        function updateAudioVisualizer(samples) {
            const canvas = document.getElementById('audioVisualizer');
            const ctx = canvas.getContext('2d');

            // Resize canvas to container
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            // Clear
            ctx.fillStyle = '#0f0f23';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw waveform
            ctx.strokeStyle = '#4ADE80';
            ctx.lineWidth = 1;
            ctx.beginPath();

            const step = Math.ceil(samples.length / canvas.width);
            const middle = canvas.height / 2;

            for (let i = 0; i < canvas.width; i++) {
                const sampleIndex = i * step;
                const sample = samples[Math.min(sampleIndex, samples.length - 1)] || 0;
                const y = middle + (sample * middle * 0.8);

                if (i === 0) {
                    ctx.moveTo(i, y);
                } else {
                    ctx.lineTo(i, y);
                }
            }

            ctx.stroke();
        }

        // ============ CHANNEL 2 - Send Instruction ============
        async function sendInstruction() {
            const instructionText = document.getElementById('instructionText').value.trim();
            const statusEl = document.getElementById('instructionStatus');
            const btn = document.getElementById('sendInstructionBtn');

            if (!instructionText) {
                statusEl.className = 'instruction-status error';
                statusEl.textContent = 'Please enter an instruction';
                return;
            }

            if (!selectedSessionId) {
                statusEl.className = 'instruction-status error';
                statusEl.textContent = 'No session selected. Select a session first.';
                return;
            }

            const apiUrl = document.getElementById('apiUrl').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();

            btn.disabled = true;
            statusEl.className = 'instruction-status';
            statusEl.textContent = 'Sending...';

            try {
                const response = await fetch(
                    `${apiUrl}/session/instruction/admin?api_key=${encodeURIComponent(apiKey)}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            instruction: instructionText,
                            session_id: selectedSessionId
                        })
                    }
                );

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || `HTTP ${response.status}`);
                }

                // Success
                statusEl.className = 'instruction-status success';
                statusEl.textContent = `Sent! ID: ${data.instruction_id}`;
                debugLog(`Instruction sent: ${instructionText.substring(0, 50)}...`, 'success');

                // Show in transcript log as SYSTEM message
                addSystemMessage(instructionText);

                // Clear textarea
                document.getElementById('instructionText').value = '';

                // Clear status after 3 seconds
                setTimeout(() => {
                    statusEl.textContent = '';
                }, 3000);

            } catch (e) {
                statusEl.className = 'instruction-status error';
                statusEl.textContent = `Error: ${e.message}`;
                debugLog(`Failed to send instruction: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        function addSystemMessage(text) {
            const log = document.getElementById('transcriptLog');

            // Remove placeholder if present
            if (log.querySelector('.placeholder') || log.innerHTML.includes('Waiting for')) {
                log.innerHTML = '';
            }

            // Reset speaker tracking (system message breaks the flow)
            currentSpeaker = null;
            currentEntry = null;

            const entry = document.createElement('div');
            entry.className = 'transcript-entry system';
            entry.innerHTML = `
                <div class="timestamp">
                    <span class="speaker system">SYSTEM</span>
                    ${getTimestamp()}
                </div>
                <div class="text">${text}</div>
            `;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        // Allow Ctrl+Enter to send instruction
        document.addEventListener('DOMContentLoaded', () => {
            const textarea = document.getElementById('instructionText');
            textarea.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    sendInstruction();
                }
            });
        });

        // Initial setup
        debugLog('Observer page loaded. Click "Refresh Sessions" to see active sessions.', 'info');
        debugLog('Default API key: dev-observer-key-12345', 'info');
        debugLog('Channel 2: Use the instruction panel to send commands to the tutor.', 'info');
    </script>
</body>
</html>
